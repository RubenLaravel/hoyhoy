#include <ArduinoJson.h> 
#include <ESP8266WiFi.h> 
#include <ESP8266HTTPClient.h>
#include <WiFiClient.h>

//needed for initial conection
#include <DNSServer.h>
#include <ESP8266WebServer.h>
#include <WiFiManager.h>

//ID AS AP 
const char *ssidNode = "Distance";
const char *passNode = "Distance";

const int buzzerPin = 2;

String macNodePost;
String macNode;
String macNodes[] = {"AB:A5:DD","AC:28:C1","37:22:AD","37:22:00","37:22:00","37:22:00","37:22:00","37:22:00","37:22:00","37:22:00"};
long rssiNode;

int elementos = (sizeof(macNodes)/sizeof(macNodes[0]));

String myMac;
String myMacPost;

String foundNode;
int networksFound;

const char* serverAddress = "http://3.81.17.144/api/verificar"; 

boolean arrayIncludeElement(String macNodes[], String macNode) {
  
 for (int b = 0; b < elementos; b++) {
  
    if (macNodePost == macNodes[b]) {
     
          return true;               
         }       
       }
         return false;
    } ;
 
   
void PostDataToServer() {

 if(WiFi.status()== WL_CONNECTED){ 
    
    Serial.print("Requesting URL: "); 
    Serial.println(serverAddress); //Post Data  
    //HTTPClient http; 
    //http.begin(serverAddress); 
    WiFiClient client;
    HTTPClient http;
    http.begin(client, serverAddress);
    http.addHeader("Content-Type", "application/json"); 
    StaticJsonDocument<200> doc;
    doc["mac1"] = foundNode;
    doc["mac2"] = myMacPost;
    String requestBody;
    serializeJson(doc, requestBody);  
    int httpResponseCode = http.POST(requestBody);
    
    if(httpResponseCode>0){
       
      String response = http.getString();                         
      Serial.println(httpResponseCode);   
      Serial.println(response);
     
    }
    
    else {
     
      Serial.printf("Error occurred while sending HTTP POST");
      Serial.print(httpResponseCode);}
    
    http.end();
    
 }else {
    
    Serial.print("Error Wifi connecting");
 }
}
 
void ScanResult() {  
  
   digitalWrite(buzzerPin,HIGH); 
   
   for (int i = 0; i < networksFound; i++) {
       //SI myMACPost ESTA DENTRO DEL ARRAY GENERAL ENTONCES SIGUES ELSE SIGUIENTE VALOR DE I ALMACENADO
       macNode = WiFi.BSSIDstr(i);
       macNodePost = macNode.substring(9);
       rssiNode = WiFi.RSSI(i);
       myMac = WiFi.macAddress();
       myMacPost = myMac.substring(9);

       if (arrayIncludeElement(macNodes, macNode) && rssiNode > -48){    //podria fluctuar -46 a -49
                 foundNode = macNodePost; 
                 Serial.print("  MantÃ©n la distancia! \n");
                 digitalWrite(buzzerPin,LOW);          
                 PostDataToServer();
                 delay(500);
                 break; 
        }                
    }
}

void setup() {

  Serial.begin(115200);
  delay(10);
  WiFi.mode(WIFI_AP_STA);
  WiFi.softAP(ssidNode,passNode);
  delay(500);
  WiFi.begin();
  
  if(WiFi.status() == WL_CONNECTED){
      Serial.println("Conectado sin portal");

  }else{
      WiFiManager wifiManager;
      //wifiManager.resetSettings();
      wifiManager.autoConnect("PortalAP","rubenamoretti");
      Serial.println("Conectado con portal");
      //WiFi.mode(WIFI_AP_STA);
      //WiFi.softAP(ssidNode,passNode);
      //delay(500);
      //WiFi.begin();
  }

  pinMode(buzzerPin,OUTPUT);
  digitalWrite(buzzerPin,HIGH); 
}

void loop() {

  networksFound = WiFi.scanNetworks();
  if (networksFound > 0) {
     ScanResult();
   }
}
